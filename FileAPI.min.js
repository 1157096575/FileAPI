/**
 * FileAPI â€” a set of tools for working with files
 * @author  RubaXa  <trash@rubaxa.org>
 */
(function(g,A){function B(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a["on"+b]=c}function n(a,b,h){c.each(b.split(" "),function(b){B(a,b,function m(c){h(c);a.addEventListener?a.removeEventListener(b,m,!1):a["on"+b]=null})})}function i(a,b,h,e){b={type:b.type||b,result:h};c.extend(b,e);a(b)}function q(a,b,c){var e=new r;n(e,"abort error progress load",function(a){i(c,a,a.target.result,{loaded:a.loaded,total:a.total,lengthComputable:a.lengthComputable})});e["readAs"+a](b)}function l(a){return"object"==
typeof a&&"length"in a}function s(a,b){return'\r\nContent-Disposition: form-data; name="'+a+'"'+(b.data?'; filename="'+t(b.name||a)+'"':"")+(b.data?"\r\nContent-Type: "+(b.type||"application/octet-stream"):"")+"\r\n\r\n"+(b.data||t(b))+"\r\n"}function u(a,b,c){var e=o.createElement("input");e.type="hidden";e.name=a;e.value=b;c&&c.appendChild(e)}var C=1,k=g.URL&&g.URL.createObjectURL&&g.URL||g.webkitURL,v=g.File,r=g.FileReader,w=g.FormData,t=g.encodeURIComponent,x=!(!v||!r),o=g.document,y=/string|number/,
z=/img/i,D=/canvas/i,p=/img|canvas/,E=/^data:[^,]+,/,c={support:x,F:function(a){return a},each:function(a,b,c){if(a)if(a.forEach)a.forEach(b,c);else if(l(a))for(var e=0,g=a.length;e<g;e++)e in a&&b.call(c,a[e],e,a);else for(e in a)a.hasOwnProperty(e)&&b.call(c,a[e],e,a)},extend:function(a){1==arguments.length?c.extend(this,a):c.each(arguments,function(b){c.each(b,function(b,c){a[c]=b})});return a},isFile:function(a){return a instanceof v},readAsDataURL:function(a,b){c.isFile(a)?q("DataURL",a,b):p.test(a.tagName)?
i(b,"load",c.toDataURL(a)):i(b,"error")},readAsBinaryString:function(a,b){q("BinaryString",a,b)},toImage:function(a){var b=new Image;b.src=c.toDataURL(a);return b},toDataURL:function(a){if("string"==typeof a)return a;if(z.test(a.nodeName)){var b=o.createElement("canvas");b.width=a.width;b.height=a.height;b.getContext("2d").drawImage(a,0,0,a.width,a.height);return c.toDataURL(b)}return a.toDataURL("image/png")},toBinaryString:function(a){return g.atob(c.toDataURL(a).replace(E,""))},readAsImage:function(a,
b){if(c.isFile(a))if(k){var h=k.createObjectURL(a);h===A?i(b,"error"):c.readAsImage(h,b)}else c.readAsDataURL(a,function(a){"load"==a.type?c.readAsImage(a.result,b):"progress"!=a&&i(b,a)});else z.test(a.nodeName)?i(b,"load",a):(D.test(a.nodeName)&&(a=c.toDataURL(a)),h=new Image,h.src=a,n(h,"error abort load",function(a){"load"==a.type&&k&&k.revokeObjectURL(a.target.src);i(b,a,"load"==a.type?a.target:null)}))},upload:function(a){function b(){if(!(n++<k||"abort"==f.statusText)){var b=e?new w:"",d=x?
new XMLHttpRequest:null;d?(f.getResponseHeader=function(a){return d.getResponseHeader(a)},f.getAllResponseHeaders=function(){return d.getAllResponseHeaders()},f.abort=function(a){f.statusText=a||"abort";d.abort(a);h(0,f)},e?c.each(i,function(a,d){l(a)?c.each(a,function(a){b.append(d,a)}):b.append(d,a)}):(c.each(i,function(a,d){b+="--"+j;l(a)?c.each(a,function(a){b+=s(d,a)}):b+=s(d,a)}),b+=j+"--",d.send=d.sendAsBinary||function(a){return function(b){b=Array.prototype.map.call(b,function(a){return a.charCodeAt(0)&
255});a.call(this,(new Uint8Array(b)).buffer)}}(d.send),m["Content-Type"]="multipart/form-data; boundary="+j),d.open("POST",a.url,!0),c.each(m,function(a,b){d.setRequestHeader(b,a)}),d.onreadystatechange=function(){f.status=d.status;f.statusText=d.statusText;f.readyState=d.readyState;if(4==d.readyState){for(var a in{"":1,XML:1,Text:1})f["response"+a]=d["response"+a];d.onreadystatechange=null;h(f.status,f)}},f.abort=function(a){f.statusText=a||"abort";if(a=d.getElementsByName("iframe")[0])try{a.stop?
a.stop():a.contentWindow.stop?a.contentWindow.stop():a.contentWindow.document.execCommand("Stop")}catch(b){}h(0,f)},d.send(b)):(d=o.createElement("div"),d.innerHTML='<form target="'+j+'" action="'+a.url+'" method="POST" enctype="multipart/form-data" style="position: absolute; left: -100px; overflow: hidden; width: 1px; height: 1px;"><iframe name="'+j+'" src="about:blank"></iframe><input value="'+j+'" name="callback" type="hidden" /></form>',d=d.firstChild,c.each(m,function(a,b){u("__HEADERS["+b+"]",
a,d)}),c.each(i,function G(a,b){y.test(a)?u(b,a,d):"INPUT"==a.tagName?(c.reset(a),d.appendChild(a)):l(a)&&c.each(a,G)}),g[j]=function(a,b){f.status=a;f.statusText=200==a?"success":"error";f.readyState=4;f.responseText=b;h(a,f);g[j]=null;delete g[j]},o.body.appendChild(d),d.submit())}}function h(b,d){200==b?(d.statusText="success",(a.success||c.F)(d.responseText,d.statusText,d)):(d.statusText="error",(a.error||c.F)(d,d.statusText));(a.complete||c.F)(d,d.statusText)}var e=!!w,i=a.data,m=c.extend({"Content-Type":"application/x-www-form-urlencoded",
"X-Requested-With":"XMLHttpRequest",Accept:"text/plain, */*; q=0.01"},a.header),j="_"+(+new Date+""+ ++C),k=0,n=0,f={status:0,statusText:0,readyState:0,getResponseHeader:function(){},getAllResponseHeaders:function(){return{}},abort:function(a){f.statusText=a||"abort";h(0,f)}};c.each(i,function d(a,b){if(!y.test(typeof a)&&!c.isFile(a)){if("file"==a.type&&a.files)i[b]=a.files;l(a)?c.each(a,d):e=!1}});e||c.each(i,function F(a){c.isFile(a)?(k++,c.readAsBinaryString(a,function(c){"load"==c.type?(a.data=
c.result,b()):h(0,{statusText:c.type})})):p.test(a.nodeName)||a.data&&p.test(a.data.nodeName)?(k++,c.readAsDataURL(a.data||a,function(c){"load"==c.type?(a.type="image/png",a.data=FileAPI.toBinaryString(c.result),b()):h(0,{statusText:c.type})})):l(a)&&c.each(a,F)});b();return f},reset:function(a){var b,c;g.jQuery?(c=jQuery(a).clone(!0).insertBefore(a).val("")[0],jQuery(a).remove()):(b=a.parentNode,c=b.insertBefore(a.cloneNode(!0),a),c.value="",b.removeChild(a));return c}};g.FileAPI=c})(this);


(function(n,h){function e(b,a){if(!(this instanceof e))return new e(b,a);this.canvas=h.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.width=this.canvas.width=b;this.height=this.canvas.height=a}var i=Math.min,m=!!function(){var b=h.createElement("Canvas");return b.getContext&&~b.toDataURL("image/png").indexOf("data:image/png")}(),g=m?!1:function(b){return b};n.extend({canvas:m,rotate:g||function(b,a){var c=b.width,d=b.height;return e(!(a%180)?c:d,a%180?c:d).rotate(a).draw(b,180==
a||270==a?-c:0,90==a||180==a?-d:0,c,d).ok()},crop:g||function(b,a,c,d,f){return e(d,f).draw(b,a,c,d,f,0,0,d,f).ok()},resize:g||function(b,a,c){return e(a,c).draw(b,0,0,a,c).ok()},resizeByMax:g||function(b,a,c){c||(c=a);var d=b.width,f=b.height,j=d/f;j>=a/c?(a=i(d,a),c=a/j):(c=i(f,c),a=c*j);return e(a,c).draw(b).ok()}});e.prototype={constructor:e,draw:function(b,a,c,d,f,e,g,h,i){var k=this.width,l=this.height;"undefined"!==typeof e?this.ctx.drawImage(b,a||0,c||0,d||k,f||l,e||0,g||0,h||k,i||l):this.ctx.drawImage(b,
a||0,c||0,d||k,f||l);return this},rotate:function(b){this.ctx.rotate(b*Math.PI/180);return this},ok:function(){this.ctx=null;return this.canvas}}})(FileAPI,document);
