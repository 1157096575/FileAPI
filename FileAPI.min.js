/**!
 * FileAPI â€” a set of tools for working with files
 * @author  RubaXa  <trash@rubaxa.org>
 * @build	canvas-to-blob FileAPI.html FileAPI.Image FileAPI.Form FileAPI.XHR FileAPI.Flash
 */
(function(c){var j=c.HTMLCanvasElement&&c.HTMLCanvasElement.prototype,g=c.BlobBuilder||c.WebKitBlobBuilder||c.MozBlobBuilder,h=g&&c.atob&&c.ArrayBuffer&&c.Uint8Array&&function(c){var d,h,a,f;d=0<=c.split(",")[0].indexOf("base64")?atob(c.split(",")[1]):decodeURIComponent(c.split(",")[1]);h=new ArrayBuffer(d.length);a=new Uint8Array(h);for(f=0;f<d.length;f+=1)a[f]=d.charCodeAt(f);d=new g;d.append(h);c=c.split(",")[0].split(":")[1].split(";")[0];return d.getBlob(c)};c.HTMLCanvasElement&&!j.toBlob&&(j.mozGetAsFile?
j.toBlob=function(c,d){c(this.mozGetAsFile("blob",d))}:j.toDataURL&&h&&(j.toBlob=function(c,d){c(h(this.toDataURL(d)))}));"undefined"!==typeof define&&define.amd?define(function(){return h}):c.dataURLtoBlob=h})(this);
(function(c,j){function g(b,k,a){b&&e.each(k.split(" "),function(k){b.addEventListener?b.addEventListener(k,a,!1):b.attachEvent?b.attachEvent("on"+k,a):b["on"+k]=a})}function h(b,k,a){b&&e.each(k.split(" "),function(k){b.addEventListener?b.removeEventListener(k,a,!1):b.detachEvent?b.detachEvent("on"+k,a):b["on"+k]=null})}function r(b,k,a){g(b,k,function u(c){a(c);h(b,k,u)})}function d(b,k,a,c,i){b={type:a.type||a,target:b,result:c};e.extend(b,i);k(b)}function l(b,k,a){if(t){var c=new t;g(c,"abort progress error load loadend",
function w(a){var e=a.type;"progress"==e?d(b,k,a,a.target.result,{loaded:a.loaded,total:a.total}):"loadend"==e?(h(c,"abort progress error load loadend",w),c=null):d(b,k,a,a.target.result)});c["readAs"+a](b)}else d(b,k,"error")}function a(b){return"object"==typeof b&&"length"in b}var f=1,p=c.createObjectURL&&c||c.URL&&URL.revokeObjectURL&&URL||c.webkitURL&&webkitURL,m=c.File,t=c.FileReader,n=c.FormData,n=!(!m||!(t&&c.Uint8Array||n)),s=c.document,q=c.dataURLtoBlob,v=/img/i,o=/canvas/i,i=/img|canvas/,
B=/^data:[^,]+,/,e={expando:"fileapi"+(new Date).getTime(),uid:function(b){return b?b[e.expando]=b[e.expando]||e.uid():e.expando+ ++f},getXHR:function(){var b;if(c.XMLHttpRequest)b=new XMLHttpRequest;else if(c.ActiveXObject)try{b=new ActiveXObject("MSXML2.XMLHttp.3.0")}catch(k){}return b},isArray:a,flash:c.FileAPI&&FileAPI.flash,support:{html5:n},event:{on:g,off:h,one:r,fix:function(b){b.target||(b.target=event.srcElement||s);3===b.target.nodeType&&(b.target=event.target.parentNode);if(null==b.pageX&&
null!=b.clientX){var k=b.target.ownerDocument||s,a=k.documentElement,k=k.body;b.pageX=b.clientX+(a&&a.scrollLeft||k&&k.scrollLeft||0)-(a&&a.clientLeft||k&&k.clientLeft||0);b.pageY=b.clientY+(a&&a.scrollTop||k&&k.scrollTop||0)-(a&&a.clientTop||k&&k.clientTop||0)}return b}},throttle:function(b,a){var e,i,f;return function z(){i=arguments;f=!0;e||(f?(b.apply(c,i),f=!1,e=setTimeout(z,a)):e=null)}},F:function(b){return b},queue:function(b){var a=0,c=0,e=!1,i=!1,f={inc:function(){c++},next:function(){a++;
setTimeout(f.check,0)},check:function(){a>=c&&!e&&f.end()},isFail:function(){return e},fail:function(){!e&&b(e=!0)},end:function(){i||(i=!0,b())}};return f},each:function(b,k,c){if(b)if(b.forEach)b.forEach(k,c);else if(a(b))for(var e=0,i=b.length;e<i;e++)e in b&&k.call(c,b[e],e,b);else for(e in b)b.hasOwnProperty(e)&&k.call(c,b[e],e,b)},extend:function(b){var a=arguments;1==a.length?b=e.extend(this,b):e.each(a,function(a){e.each(a,function(a,k){b[k]=a})});return b},isFile:function(b){return b instanceof
m},isCanvas:function(b){return b&&o.test(b.nodeName)},readAsDataURL:function(b,a){e.isFile(b)?l(b,a,"DataURL"):e.isCanvas(b)?d(b,a,"load",e.toDataURL(b)):d(b,a,"error")},readAsBinaryString:function(b,a){e.isFile(b)?l(b,a,"BinaryString"):d(b,a,"error")},toDataURL:function(b){if("string"==typeof b)return b;if(b.toDataURL)return b.toDataURL("image/png")},toBinaryString:function(b){return c.atob(e.toDataURL(b).replace(B,""))},readAsImage:function(b,a,c){if(e.isFile(b))if(p){var i=p.createObjectURL(b);
i===j?d(b,a,"error"):e.readAsImage(i,a,c)}else e.readAsDataURL(b,function(i){"load"==i.type?e.readAsImage(i.result,a,c):(c||"error"==i.type)&&d(b,a,i,null,{loaded:i.loaded,total:i.total})});else e.isCanvas(b)?d(b,a,"load",b):v.test(b.nodeName)?b.complete?d(b,a,"load",b):r(b,"error abort load",function w(c){"load"==c.type&&p&&p.revokeObjectURL(b.src);h(b,"error abort load",w);d(b,a,c,b)}):(i=new Image,i.src=b.dataURL||b,e.readAsImage(i,a,c))},getFiles:function(b){var a=[],c=arguments;b.originalEvent&&
(b=b.originalEvent);b.dataTransfer?b=b.dataTransfer:b.target&&(b=b.target);b.files&&(b=b.files);b.length&&a.push.apply(a,b);if(3==c.length)c[0]=a,e.filterFiles.apply(e,c);else return a},getFileInfo:function(b,a){e.readAsImage(b,function(b){a("load"==b.type&&b.target)})},filter:function(b,a){var c=[],e=0,i=b.length,f;for(e;e<i;e++)e in b&&(f=b[e],a.call(f,f,e,b)&&c.push(f));return c},filterFiles:function(b,a,c){var i=b.concat(),f,d=[],p=[];(function x(){i.length?(f=i.shift(),/image/.test(f.type)?e.getFileInfo(f,
function(b){(a(f,b)?d:p).push(f);x()}):((a(f,{})?d:p).push(f),x())):c(d,p)})()},upload:function(b){var b=e.extend({beforeupload:e.F,upload:e.F,fileupload:e.F,fileprogress:e.F,filecomplete:e.F,progress:e.F,complete:e.F},b),a=new e.XHR(b),c=this._getFilesDataArray(b.files),i=0,f=0,d=0;e.each(c,function(b){i+=b.size});b.total=i;b.loaded=f;b.beforeupload(a,b);(function A(){var p=c.shift(),h=this;"abort"!=a.statusText&&p?this._getFormData(b,p,function(c){f||b.upload(a,b.files);var m=new e.XHR(e.extend({},
b,{upload:function(){b.fileupload(m)},progress:function(a){a.lengthComputable&&(d=f+=i*p.part*(a.loaded/a.total)-d,b.fileprogress(a,m),b.progress({type:a.type,total:i,loaded:b.loaded=f,lengthComputable:!0}))},complete:function(c){e.extend(a,m);b.loaded=f+=f-d+i*p.part;b.filecomplete(c,m);A.call(h)}}));p.part=p.size/i;m.send(c);a.abort=function(){m.abort()}}):b.complete(a.statusText,a)}).call(this);return a},_getFilesDataArray:function(b){var c=[];e.each(b,function y(b,i){a(b)?e.each(b,function(b,
a){y(b,i+"["+a+"]")}):c.push({name:i,file:b,size:b.size})});return c},_getFormData:function(b,a,c){var f=a.file,d=a.name,p=f.name,m=f.type,a=e.support.transform&&b.imageTransform,h="number"==typeof(a.maxWidth||a.minWidth||a.width),g=new e.Form,n=e.queue(function(){c(g)});a&&(/image/.test(f.type)||i.test(f.nodeType))?(n.inc(),h&&(a=[a]),e.Image.transform(f,a,function(a,c){h&&!a?(q||(c[0]=e.toBinaryString(c[0]),g.multipart=!0),g.append(d,c[0],p,m)):(a||(e.each(c,function(b,a){q||(b=e.toBinaryString(b),
g.multipart=!0);g.append(d+"["+a+"]",b,p,m)}),d+="[original]"),(a||b.imageOriginal)&&g.append(d,f,p,m));n.next()})):g.append(d,f,p);e.each(b.data,function C(b,a){typeof b=="object"?e.each(b,function(b,c){C(b,a+"["+c+"]")}):g.append(a,b)});n.check()},reset:function(b){var a,i;c.jQuery?(i=jQuery(b).clone(!0).insertBefore(b).val("")[0],jQuery(b).remove()):(a=b.parentNode,i=a.insertBefore(b.cloneNode(!0),b),i.value="",a.removeChild(b));return i},load:function(b,a){var c=e.getXHR();c?(c.open("GET",b,!0),
c.overrideMimeType&&c.overrideMimeType("text/plain; charset=x-user-defined"),g(c,"progress",function(b){b.lengthComputable&&a({type:b.type,loaded:b.loaded,total:b.total},c)}),c.onreadystatechange=function(){if(4==c.readyState)if(c.onreadystatechange=null,200==c.status){b=b.split("/");var i={name:b[b.length-1],size:c.getResponseHeader("Content-Length"),type:c.getResponseHeader("Content-Type")};i.dataURL="data:"+i.type+";base64,"+e.encode64(c.responseBody||c.responseText);a({type:"load",result:i})}else a({type:"error"})},
c.send(null)):a({type:"error"});return c},encode64:function(b){var a="",c=0;for("string"!==typeof b&&(b=String(b));c<b.length;){var i=b.charCodeAt(c++)&255,e=b.charCodeAt(c++)&255,f=b.charCodeAt(c++)&255,d=i>>2,i=(i&3)<<4|e>>4;isNaN(e)?e=f=64:(e=(e&15)<<2|f>>6,f=isNaN(f)?64:f&63);a+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(d)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(i)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(e)+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f)}return a}};c.FileAPI=e})(this);
(function(c,j,g){function h(a){if(!(this instanceof h))return new h(a);this.setData(a);this.trans={sx:0,sy:0,sw:0,sh:0,dx:0,dy:0,dw:0,dh:0,resize:0,deg:0}}var r=Math.min,d=Math.round,l=j.createElement("canvas"),l=!(!l.toDataURL||!~l.toDataURL("image/png").indexOf("data:image/png"));h.support=l;h.prototype={constructor:h,set:function(a){c.extend(this.trans,a);return this},setData:function(a){this.data=a;return this},crop:function(a,c,d,m){d===g&&(d=a,m=c,a=c=0);return this.set({sx:a,sy:c,sw:d,sh:m})},
resize:function(a,c,d){"number"!==typeof c&&(d=d||c,c=a);return this.set({dw:a,dh:c,resize:d})},preview:function(a,c){return this.set({dw:a,dh:c||a,resize:"preview"})},rotate:function(a){return this.set({deg:a})},_load:function(a,f){var d=this;c.readAsImage(a,function(a){f.call(d,"load"!=a.type,a.result)})},_trans:function(a,c){var d=j.createElement("canvas"),m=this.transform(a),h=d.getContext("2d"),g=m.deg,l=m.dw,q=m.dh;d.width=!(g%180)?l:q;d.height=g%180?l:q;h.rotate(g*Math.PI/180);h.drawImage(a,
m.sx,m.sy,m.sw,m.sh,180==g||270==g?-l:0,90==g||180==g?-q:0,l,q);c.call(this,!1,d)},transform:function(a){var f=c.extend({},this.trans),g=f.sw=f.sw||a.width,a=f.sh=f.sh||a.height,h=f.dw=f.dw||f.sw,l=f.dh=f.dh||f.sh,n=g/a,j=h/l,q=f.resize;if("preview"==q){if(h!=g||l!=a)if(j>=n?(n=g,q=n/j):(q=a,n=q*j),n!=g||q!=a)f.sx=~~((g-n)/2),f.sy=~~((a-q)/2),g=n,a=q}else q&&("min"==q?(h=d(n<j?r(g,h):l*n),l=d(n<j?h/n:r(a,l))):(h=d(n>=j?r(g,h):l*n),l=d(n>=j?h/n:r(a,l))));f.sw=g;f.sh=a;f.dw=h;f.dh=l;return f},get:function(a){h.support?
this._load(this.data,function(c,d){c?a(c):this._trans(d,a)}):a("not_support")},toData:function(a){this.get(a)}};h.transform=function(a,f,d){c.getFileInfo(a,function(a){var g={},l=a.result,j=c.queue(function(a){d(a,g)});"load"==a.type?c.each(f,function(a,c){if(!j.isFail()){var f=h(l);if("function"==typeof a)a(l,f);else if(a.width)f[a.preview?"preview":"resize"](a.width,a.height,a.type);else a.maxWidth&&(l.width>a.maxWidth||l.height>a.maxHeight)?f.resize(a.maxWidth,a.maxHeight,"max"):a.minWidth&&(l.width<
a.minWidth||l.height<a.minHeight)&&f.resize(a.minWidth,a.minHeight,"min");j.inc();f.toData(function(a,f){a?j.fail():(g[c]=f,j.next())})}}):j.fail()})};c.support.transform=l;c.Image=h})(FileAPI,document);
(function(c,j,g,h){var r=j.encodeURIComponent,d=j.FormData,j=function(){this._items=[];this.size=0};j.prototype={append:function(c,a,f,d){this._items.push({name:c,blob:a,file:f||a.name,type:d||a.type})},each:function(c){for(var a=0,f=this._items.length;a<f;a++)c.call(this,this._items[a])},toData:function(d){c.support.html5?this.multipart?(console.log("toMultipartData"),this.toMultipartData(d)):(console.log("toFormData"),this.toFormData(d)):(console.log("toHtmlData"),this.toHtmlData(d))},_to:function(d,
a,f,g){var j=c.queue(function(){a(d)});g===h&&(g=f,f=h);this.each(function(a){g(a,d,j,f)});j.check()},toHtmlData:function(d){this._to(g.createDocumentFragment(),d,function(a){c.reset(a.blob);data.appendChild(a.blob)})},toFormData:function(c){this._to(new d,c,function(a,c,d){a.file&&c.append("_"+a.name,a.file);a.blob.toBlob?(d.inc(),a.blob.toBlob(function(g){c.append(a.name,g,a.file);d.next()},"image/png")):a.file?c.append(a.name,a.blob,a.file):c.append(a.name,a.blob)})},toMultipartData:function(d){this._to([],
d,c.expando,function(a,c,d,g){c.push("--_"+g+('\r\nContent-Disposition: form-data; name="'+a.name+'"'+(a.file?'; filename="'+r(a.file)+'"':"")+(a.file?"\r\nContent-Type: "+(a.type||"application/octet-stream"):"")+"\r\n\r\n"+(a.file?a.blob:r(a.blob))+"\r\n"))})}};c.Form=j})(FileAPI,this,document);
(function(c){var j=function(c){this.options=c};j.prototype={status:0,statusText:"",getResponseHeader:function(c){return this.xhr&&this.xhr.getResponseHeader(c)},getAllResponseHeaders:function(){return this.xhr&&this.xhr.getAllResponseHeaders()||{}},end:function(g){var h=this.options;this.abort=c.F;this.status=g;h.complete(200==g?"success":"error",this)},abort:function(){this.statusText="abort";this.end(0);this.xhr&&this.xhr.abort()},send:function(c){var h=this,j=this.options;c.toData(function(c){j.upload(j,
h);h._sendData.call(h,j,c)})},_sendData:function(g,h){var j=this;console.log("base._sendData");if(!h.nameName){var d=this.xhr=c.getXHR();d.open("POST",g.url,!0);d.withCredential="true";c.each(g.headers,function(a,c){d.setRequestHeader(c,a)});if(d.upload)c.event.on(d.upload,"progress",c.throttle(function(a){g.progress(a,g,j)},100));d.onreadystatechange=function(){j.status=d.status;j.statusText=d.statusText;j.readyState=d.readyState;if(4==d.readyState){for(var a in{"":1,XML:1,Text:1,Body:1})j["response"+
a]=d["response"+a];d.onreadystatechange=null;j.end(d.status)}};if(c.isArray(h))if(d.setRequestHeader("Content-Type","multipart/form-data; boundary=_"+c.expando),h=h.join("")+"--_"+c.expando+"--",d.sendAsBinary)d.sendAsBinary(h);else{var l=Array.prototype.map.call(h,function(a){return a.charCodeAt(0)&255});d.send((new Uint8Array(l)).buffer)}else d.send(h)}}};c.XHR=j})(FileAPI);
(function(c,j,g){var h=c.support,r=j.navigator,d=r.mimeTypes,l=!1;if(r.plugins&&"object"==typeof r.plugins["Shockwave Flash"])l=r.plugins["Shockwave Flash"].description&&!(d&&d["application/x-shockwave-flash"]&&!d["application/x-shockwave-flash"].enabledPlugin);else try{l=!(!j.ActiveXObject||!new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(a){}h.flash=l;if(c.support.flash){var f=function(a,c){if(a&&a.style){var e,b;for(e in c)b=c[e],"number"==typeof b&&(b+="px"),a.style[e]=b}},p=function(a){var d=
c.uid();a.uid=d;o._fn[d]=a;return"FileAPI.Flash._fn."+d},m=function(a){delete o._fn[a.uid]},t=0,n={},s,q={image:"png|jpg|jpeg|bmp|gif|ico|tif|tiff|tga|pcx|cbz|cbr",audio:"m4a|flac|aac|rm|mpa|wav|wma|ogg|mp3|mp2|m3u|mod|amf|dmf|dsm|far|gdm|imf|it|m15|med|okt|s3m|stm|sfx|ult|uni|xm|sid|ac3|dts|cue|aif|aiff|wpl|ape|mac|mpc|mpp|shn|wv|nsf|spc|gym|adplug|adx|dsp|adp|ymf|ast|afc|hps|xsp",video:"m4v|3gp|nsv|ts|ty|strm|rm|rmvb|m3u|ifo|mov|qt|divx|xvid|bivx|vob|nrg|img|iso|pva|wmv|asf|asx|ogm|m2v|avi|bin|dat|dvr-ms|mpg|mpeg|mp4|mkv|avc|vp3|svq3|nuv|viv|dv|fli|flv|wpl"},
v={},o={_fn:{},init:function(){var a=g.getElementById("__FileAPI__");a?o.publish(o.wrapper=a):10>t&&setTimeout(o.init,50*++t)},publish:function(a){var d={id:c.expando,src:"./FileAPI.flash.swf",flashVars:"callback=FileAPI.Flash.event"};a.innerHTML='<object id="#id#" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="100%" height="100%"><param name="movie" value="#src#" /><param name="flashvars" value="#flashVars#" /><param name="swliveconnect" value="true" /><param name="allowScriptAccess" value="always" /><param name="wmode" value="transparent" /><param name="menu" value="false" /><embed flashvars="#flashVars#" swliveconnect="true" allowScriptAccess="always" name="#id#" src="#src#"  width="100%" height="100%" menu="false" wmode="transparent" type="application/x-shockwave-flash"></embed></object>'.replace(/#(\w+)#/ig,
function(a,b){return d[b]})},ready:function(){o.ready=c.F;o.patch();c.each(q,function(a,c){v[c]=RegExp("("+a+")","i")});c.event.on(g,"mouseover",o.mouseover);c.event.on(g,"mousedown",function(a){o.mouseover(a)&&(a.preventDefault?a.preventDefault():a.returnValue=!0)})},mouseover:function(a){a=c.event.fix(j.event||a);a=a.target;if(/input/i.test(a.nodeName)&&"file"==a.type)return a.parentNode.insertBefore(o.wrapper,a),s=a,f(o.wrapper,{width:a.offsetWidth,height:a.offsetHeight,top:a.offsetTop}),!0;a.name!=
c.expando&&o.mouseout()},mouseout:function(){o.wrapper.parentNode!==g.body&&(g.body.appendChild(o.wrapper),f(o.wrapper,{top:0,left:0,width:1,height:1}))},event:function(a){var c=a.type;if("ready"==c)return console.log("Flash.ready"),setTimeout(o[c],30),!0;c in o&&(console.log(a),o[c](a.target))},select:function(a){var d=c.uid(s);c.each(a.files,function(a){c.each(v,function(b,c){b.test(a.type)&&(a.type=c+"/"+a.type)})});n[d]=a.files;g.createEvent?(a=g.createEvent("Event"),a.initEvent("change",!0,!1),
s.dispatchEvent(a)):g.createEventObject&&(a=g.createEventObject(),s.fireEvent("onchange",a))},cmd:function(a,d){var e=c.expando,e=g[e]||j[e]||g.embeds[e];try{return e.cmd(a,d)}catch(b){}},patch:function(){c.extend(c,{getFiles:function(a){var d=c.isArray(a)?a:n[c.uid(a.target||a.srcElement||a)],e=arguments;if(3==e.length)e[0]=d,c.filterFiles.apply(c,e);else return d},getFileInfo:function(a,c){c(!1)}});c.extend(FileAPI.Image.prototype,{_load:function(a,d){var e=this;"preview"==e.trans.resize?c.getFileInfo(a,
function(b){b&&c.extend(a,b);d.call(e,!1,a)}):d.call(e,"flash_resize_not_support")},_trans:function(a,c){o.cmd("setResize",{type:"preview",enable:!0,resizeSize:this.trans.dw});o.cmd("loadAsDataURL",{id:a.uid,callback:p(function b(d){if("load"==d.type){d.target.type&&(a.type=d.target.type);var f=new Image;f.src="data:"+a.type+";base64,"+d.target.result;c(!0,f);m(b)}else"error"==d.type&&(c("flash_resize_error"),m(b))})})}});c.extend(c.Form.prototype,{toData:function(a){console.log("flash.Form.toData");
a(this._items)}});c.extend(c.XHR.prototype,{_sendData:function(a,d){var e={},b,f,g=this;c.each(d,function(a){a.file?(b=a.blob.uid,f=a):e[a.name]=a.blob});console.log("flash._sendData:",f,e);this.xhr={headers:{},abort:function(){o.cmd("abort",{id:b})},getResponseHeader:function(a){return this.headers[a]},getAllResponseHeaders:function(){return this.headers}};o.cmd("upload",{id:b,url:a.url,name:f.name,data:e,headers:a.headers,callback:p(function u(b){console.log(b);var c=b.type,d=b.target;"progress"==
c?(b.lengthComputable=!0,a.progress(b)):"error"==c||"upload"==c?(m(u),g.xhr.headers=b.headers||{},g.responseText=d&&String(d.result).replace(/%22/g,'"').replace(/%5c/g,"\\").replace(/%26/g,"&").replace(/%25/g,"%"),g.end("error"==c?500:200)):"abort"==c&&m(u)})})}})}};c.Flash=o;o.init()}})(FileAPI,this,document);window.ajs&&ajs.loaded&&ajs.loaded("{FileAPI}FileAPI.min");"function"===typeof define&&define.amd&&define("FileAPI",[],function(){return window.FileAPI||{}});
