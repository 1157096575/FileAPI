/**
 * FileAPI â€” a set of tools for working with files
 * @author  RubaXa  <trash@rubaxa.org>
 */
(function(g,G){function k(a,b,c){a&&(a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c)}function r(a,b,c){a&&(a.addEventListener?a.removeEventListener(b,c,!1):a.detachEvent?a.detachEvent("on"+b,c):a["on"+b]=null)}function s(a,b,c){d.each(b.split(" "),function(b){k(a,b,function p(d){c(d);r(a,b,p)})})}function i(a,b,c,e){b={type:b.type||b,result:c};d.extend(b,e);a(b)}function u(a,b,c){var e=new v,d=function(a){i(c,a,a.target.result,{loaded:a.loaded,total:a.total})};
s(e,"abort error load loadend",function(a){"loadend"==a.type?(r(e,"progress",d),e=null):i(c,a,a.target.result)});k(e,"progress",d);e["readAs"+a](b)}function n(a){return"object"==typeof a&&"length"in a}function w(a,b){return'\r\nContent-Disposition: form-data; name="'+a+'"'+(b.data?'; filename="'+x(b.name||a)+'"':"")+(b.data?"\r\nContent-Type: "+(b.type||"application/octet-stream"):"")+"\r\n\r\n"+(b.data||x(b))+"\r\n"}function y(a,b,c){var e=l.createElement("input");e.type="hidden";e.name=a;e.value=
b;c&&c.appendChild(e)}function H(a,b){if(q&&b instanceof q)a.send(b);else if(a.sendAsBinary)a.sendAsBinary(b);else{var c=Array.prototype.map.call(b,function(a){return a.charCodeAt(0)&255});a.send((new Uint8Array(c)).buffer)}}function z(a){if(g.XMLHttpRequest)a=new XMLHttpRequest;else if(g.ActiveXObject)try{a=new ActiveXObject("MSXML2.XMLHttp.3.0")}catch(b){}return a}function A(a){if(!a.target)a.target=event.srcElement||l;if(3===a.target.nodeType)a.target=event.target.parentNode;if(null==a.pageX&&
null!=a.clientX){var b=a.target.ownerDocument||l,c=b.documentElement,b=b.body;a.pageX=a.clientX+(c&&c.scrollLeft||b&&b.scrollLeft||0)-(c&&c.clientLeft||b&&b.clientLeft||0);a.pageY=a.clientY+(c&&c.scrollTop||b&&b.scrollTop||0)-(c&&c.clientTop||b&&b.clientTop||0)}return a}var I=1,o=g.URL&&g.URL.createObjectURL&&g.URL||g.webkitURL,B=g.File,v=g.FileReader,q=g.FormData,x=g.encodeURIComponent,C=!(!B||!v),l=g.document,D=/string|number/,E=/img/i,J=/canvas/i,t=/img|canvas/,K=/^data:[^,]+,/,F=[],d={support:C,
event:{on:k,off:r,one:s,fix:A},F:function(a){return a},each:function(a,b,c){if(a)if(a.forEach)a.forEach(b,c);else if(n(a))for(var e=0,d=a.length;e<d;e++)e in a&&b.call(c,a[e],e,a);else for(e in a)a.hasOwnProperty(e)&&b.call(c,a[e],e,a)},extend:function(a){1==arguments.length?d.extend(this,a):d.each(arguments,function(b){d.each(b,function(b,e){a[e]=b})});return a},inherit:function(a){d.each(a,function(a,c){var e=d[c];d[c]=function(){this.parent=function(){return e.apply(d,arguments)};return a.apply(d,
arguments)}})},isFile:function(a){return a instanceof B},readAsDataURL:function(a,b){d.isFile(a)?u("DataURL",a,b):t.test(a.tagName)?i(b,"load",d.toDataURL(a)):i(b,"error")},readAsBinaryString:function(a,b){u("BinaryString",a,b)},toImage:function(a){var b=new Image;b.src=d.toDataURL(a);return b},toDataURL:function(a){if("string"==typeof a)return a;if(E.test(a.nodeName)){var b=l.createElement("canvas");b.width=a.width;b.height=a.height;b.getContext("2d").drawImage(a,0,0,a.width,a.height);return d.toDataURL(b)}return a.toDataURL("image/png")},
toBinaryString:function(a){return g.atob(d.toDataURL(a).replace(K,""))},readAsImage:function(a,b){if(d.isFile(a))if(o){var c=o.createObjectURL(a);c===G?i(b,"error"):d.readAsImage(c,b)}else d.readAsDataURL(a,function(a){"load"==a.type?d.readAsImage(a.result,b):i(b,a,null,{loaded:a.loaded,total:a.total})});else E.test(a.nodeName)?i(b,"load",a):(J.test(a.nodeName)&&(a=d.toDataURL(a)),c=new Image,c.src=a,s(c,"error abort load",function(a){"load"==a.type&&o&&o.revokeObjectURL(a.target.src);i(b,a,"load"==
a.type?a.target:null)}))},upload:function(a){function b(){if(!(o++<i||"abort"==h.statusText)){var b=e?new q:"",f=C?z():null;f?(h.getResponseHeader=function(a){return f.getResponseHeader(a)},h.getAllResponseHeaders=function(){return f.getAllResponseHeaders()},h.abort=function(a){h.statusText=a||"abort";f.abort(a);c(0,h)},e?d.each(m,function(a,c){n(a)?d.each(a,function(a){b.append(c,a)}):b.append(c,a)}):(d.each(m,function(a,c){n(a)?d.each(a,function(a){b+="--"+j+w(c,a)}):b+="--"+j+w(c,a)}),b+="--"+
j+"--",p["Content-Type"]="multipart/form-data; boundary="+j),f.open("POST",a.url,!0),d.each(p,function(a,b){f.setRequestHeader(b,a)}),f.upload&&a.progress&&k(f.upload,"progress",function(b){b.lengthComputable&&a.progress(b.loaded,b.total,h)}),f.onreadystatechange=function(){h.status=f.status;h.statusText=f.statusText;h.readyState=f.readyState;if(4==f.readyState){for(var a in{"":1,XML:1,Text:1,Body:1})h["response"+a]=f["response"+a];f.onreadystatechange=null;c(h.status,h)}},H(f,b)):(f=l.createElement("div"),
f.innerHTML='<form target="'+j+'" action="'+a.url+'" method="POST" enctype="multipart/form-data" style="position: absolute; left: -100px; overflow: hidden; width: 1px; height: 1px;"><iframe name="'+j+'" src="about:blank"></iframe><input value="'+j+'" name="callback" type="hidden" /></form>',f=f.firstChild,d.each(p,function(a,b){y("__HEADERS["+b+"]",a,f)}),d.each(m,function M(a,b){D.test(a)?y(b,a,f):"INPUT"==a.tagName?(d.reset(a),f.appendChild(a)):n(a)&&d.each(a,M)}),g[j]=function(a,b){h.status=a;
h.statusText=200==a?"success":"error";h.readyState=4;h.responseText=b;c(a,h);g[j]=null;delete g[j]},h.abort=function(a){h.statusText=a||"abort";if(a=f.getElementsByName("iframe")[0])try{a.stop?a.stop():a.contentWindow.stop?a.contentWindow.stop():a.contentWindow.document.execCommand("Stop")}catch(b){}c(0,h)},l.body.appendChild(f),f.submit())}}function c(b,c){200==b?(c.statusText="success",(a.success||d.F)(c.responseText,c.statusText,c)):(c.statusText="error",(a.error||d.F)(c,c.statusText));(a.complete||
d.F)(c,c.statusText)}var e=!!q,m=a.data,p=d.extend({"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest",Accept:"text/plain, */*; q=0.01"},a.header),j="_"+(+new Date+""+ ++I),i=0,o=0,h={status:0,statusText:0,readyState:0,getResponseHeader:function(){},getAllResponseHeaders:function(){return{}},abort:function(a){h.statusText=a||"abort";c(0,h)}};d.each(m,function f(a,b){if(!D.test(typeof a)&&!d.isFile(a)){if("file"==a.type&&a.files)m[b]=a.files;n(a)?d.each(a,f):e=!1}});
e||d.each(m,function L(a){d.isFile(a)?(i++,d.readAsBinaryString(a,function(d){"load"==d.type?(a.data=d.result,b()):c(0,{statusText:d.type})})):t.test(a.nodeName)||a.data&&t.test(a.data.nodeName)?(i++,d.readAsDataURL(a.data||a,function(e){"load"==e.type?(a.type="image/png",a.data=d.toBinaryString(e.result),b()):c(0,{statusText:e.type})})):n(a)&&d.each(a,L)});b();return h},reset:function(a){var b,c;g.jQuery?(c=jQuery(a).clone(!0).insertBefore(a).val("")[0],jQuery(a).remove()):(b=a.parentNode,c=b.insertBefore(a.cloneNode(!0),
a),c.value="",b.removeChild(a));return c},load:function(a,b){var c=z();c?(c.open("GET",a,!0),c.overrideMimeType&&c.overrideMimeType("text/plain; charset=x-user-defined"),k(c,"progress",function(a){a.lengthComputable&&b({type:a.type,loaded:a.loaded,total:a.total},c)}),c.onreadystatechange=function(){if(4==c.readyState)if(c.onreadystatechange=null,200==c.status){a=a.split("/");var e={name:a[a.length-1],size:c.getResponseHeader("Content-Length"),type:c.getResponseHeader("Content-Type")};e.dataURL="data:"+
e.type+";base64,"+d.encode64(c.responseBody||c.responseText);b({type:"load",result:e})}else b({type:"error"})},c.send(null)):b({type:"error"});return c},encode64:function(a){for(var b="",c=0;c<a.length;){var d=a.charCodeAt(c++)&255,g=a.charCodeAt(c++)&255,i=a.charCodeAt(c++)&255,j=d>>2,d=(d&3)<<4|g>>4;isNaN(g)?g=i=64:(g=(g&15)<<2|i>>6,i=isNaN(i)?64:i&63);b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(j)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(d)+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(i)}return b},onselect:function(a){F.push(a)}};g.FileAPI=d;k(l,"mousedown",function(a){var b=A(g.event||a).target;if("INPUT"==b.nodeName&&"file"==b.type&&!b.__FileAPIOnSel)b.__FileAPIOnSel=1,k(b,"change",function(){d.each(F,function(a){a(b.files,b)})})})})(this);


(function(n,h){function e(b,a){if(!(this instanceof e))return new e(b,a);this.canvas=h.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.width=this.canvas.width=b;this.height=this.canvas.height=a}var i=Math.min,m=!!function(){var b=h.createElement("Canvas");return b.getContext&&~b.toDataURL("image/png").indexOf("data:image/png")}(),g=m?!1:function(b){return b};n.extend({canvas:m,rotate:g||function(b,a){var c=b.width,d=b.height;return e(!(a%180)?c:d,a%180?c:d).rotate(a).draw(b,180==
a||270==a?-c:0,90==a||180==a?-d:0,c,d).ok()},crop:g||function(b,a,c,d,f){return e(d,f).draw(b,a,c,d,f,0,0,d,f).ok()},resize:g||function(b,a,c){return e(a,c).draw(b,0,0,a,c).ok()},resizeByMax:g||function(b,a,c){c||(c=a);var d=b.width,f=b.height,j=d/f;j>=a/c?(a=i(d,a),c=a/j):(c=i(f,c),a=c*j);return e(a,c).draw(b).ok()}});e.prototype={constructor:e,draw:function(b,a,c,d,f,e,g,h,i){var k=this.width,l=this.height;"undefined"!==typeof e?this.ctx.drawImage(b,a||0,c||0,d||k,f||l,e||0,g||0,h||k,i||l):this.ctx.drawImage(b,
a||0,c||0,d||k,f||l);return this},rotate:function(b){this.ctx.rotate(b*Math.PI/180);return this},ok:function(){this.ctx=null;return this.canvas}}})(FileAPI,document);
