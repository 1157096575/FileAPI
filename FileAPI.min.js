/**
 * FileAPI â€” a set of tools for working with files
 * @author  RubaXa  <trash@rubaxa.org>
 */
function(i){function A(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a["on"+b]=c}function m(a,b,g){c.each(b.split(" "),function(b){A(a,b,function l(c){g(c);a.addEventListener?a.removeEventListener(b,l,!1):a["on"+b]=null})})}function h(a,b,g,e){b={type:b.type||b,result:g};c.extend(b,e);a(b)}function q(a,b,c){var e=new r;m(e,"abort error progress load",function(a){h(c,a,a.target.result,{loaded:a.loaded,total:a.total,lengthComputable:a.lengthComputable})});e["readAs"+a](b)}function k(a){return"object"==
typeof a&&"length"in a}function s(a,b){return'\r\nContent-Disposition: form-data; name="'+a+'"'+(b.data?'; filename="'+t(b.name||a)+'"':"")+(b.data?"\r\nContent-Type: "+(b.type||"application/octet-stream"):"")+"\r\n\r\n"+(b.data||t(b))+"\r\n"}function u(a,b,c){var e=n.createElement("input");e.type="hidden";e.name=a;e.value=b;c&&c.appendChild(e)}var B=1,v=i.File,r=i.FileReader,w=i.FormData,t=i.encodeURIComponent,x=!(!v||!r),n=i.document,y=/string|number/,z=/img/i,C=/canvas/i,o=/img|canvas/,D=/^data:[^,]+,/,
c={support:x,F:function(a){return a},each:function(a,b,c){if(a)if(a.forEach)a.forEach(b,c);else if(k(a))for(var e=0,i=a.length;e<i;e++)e in a&&b.call(c,a[e],e,a);else for(e in a)a.hasOwnProperty(e)&&b.call(c,a[e],e,a)},extend:function(a){1==arguments.length?c.extend(this,a):c.each(arguments,function(b){c.each(b,function(b,c){a[c]=b})});return a},isFile:function(a){return a instanceof v},readAsDataURL:function(a,b){c.isFile(a)?q("DataURL",a,b):o.test(a.tagName)?h(b,"load",c.toDataURL(a)):h(b,"error")},
readAsBinaryString:function(a,b){q("BinaryString",a,b)},toImage:function(a){var b=new Image;b.src=c.toDataURL(a);return b},toDataURL:function(a){if("string"==typeof a)return a;if(z.test(a.nodeName)){var b=n.createElement("canvas");b.width=a.width;b.height=a.height;b.getContext("2d").drawImage(a,0,0,a.width,a.height);return c.toDataURL(b)}return a.toDataURL("image/png")},toBinaryString:function(a){return i.atob(c.toDataURL(a).replace(D,""))},readAsImage:function(a,b){if(c.isFile(a))c.readAsDataURL(a,
function(a){"load"==a.type?c.readAsImage(a.result,b):"progress"!=a&&h(b,a)});else if(z.test(a.nodeName))h(b,"load",a);else if(C.test(a.nodeName))a=c.toDataURL(a);else{var g=new Image;g.src=a;g.complete?h(b,"load",g):m(g,"error abort load",function(a){h(b,a,"load"==a.type?a.target:null)})}},upload:function(a){function b(){if(!(m++<p||"abort"==f.statusText)){var b=e?new w:"",d=x?new XMLHttpRequest:null;d?(f.getResponseHeader=function(a){return d.getResponseHeader(a)},f.getAllResponseHeaders=function(){return d.getAllResponseHeaders()},
f.abort=function(a){f.statusText=a||"abort";d.abort(a);g(0,f)},e?c.each(h,function(a,d){k(a)?c.each(a,function(a){b.append(d,a)}):b.append(d,a)}):(c.each(h,function(a,d){b+="--"+j;k(a)?c.each(a,function(a){b+=s(d,a)}):b+=s(d,a)}),b+=j+"--",d.send=d.sendAsBinary||function(a){return function(b){b=Array.prototype.map.call(b,function(a){return a.charCodeAt(0)&255});a.call(this,(new Uint8Array(b)).buffer)}}(d.send),l["Content-Type"]="multipart/form-data; boundary="+j),d.open("POST",a.url,!0),c.each(l,
function(a,b){d.setRequestHeader(b,a)}),d.onreadystatechange=function(){f.status=d.status;f.statusText=d.statusText;f.readyState=d.readyState;if(4==d.readyState){for(var a in{"":1,XML:1,Text:1})f["response"+a]=d["response"+a];d.onreadystatechange=null;g(f.status,f)}},f.abort=function(a){f.statusText=a||"abort";if(a=d.getElementsByName("iframe")[0])try{a.stop?a.stop():a.contentWindow.stop?a.contentWindow.stop():a.contentWindow.document.execCommand("Stop")}catch(b){}g(0,f)},d.send(b)):(d=n.createElement("div"),
d.innerHTML='<form target="'+j+'" action="'+a.url+'" method="POST" enctype="multipart/form-data" style="position: absolute; left: -100px; overflow: hidden; width: 1px; height: 1px;"><iframe name="'+j+'" src="about:blank"></iframe><input value="'+j+'" name="callback" type="hidden" /></form>',d=d.firstChild,c.each(l,function(a,b){u("__HEADERS["+b+"]",a,d)}),c.each(h,function F(a,b){y.test(a)?u(b,a,d):"INPUT"==a.tagName?(c.reset(a),d.appendChild(a)):k(a)&&c.each(a,F)}),i[j]=function(a,b){f.status=a;
f.statusText=200==a?"success":"error";f.readyState=4;f.responseText=b;g(a,f);i[j]=null;delete i[j]},n.body.appendChild(d),d.submit())}}function g(b,d){200==b?(d.statusText="success",(a.success||c.F)(d.responseText,d.statusText,d)):(d.statusText="error",(a.error||c.F)(d,d.statusText));(a.complete||c.F)(d,d.statusText)}var e=!!w,h=a.data,l=c.extend({"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest",Accept:"text/plain, */*; q=0.01"},a.header),j="_"+(+new Date+""+
++B),p=0,m=0,f={status:0,statusText:0,readyState:0,getResponseHeader:function(){},getAllResponseHeaders:function(){return{}},abort:function(a){f.statusText=a||"abort";g(0,f)}};c.each(h,function d(a,b){if(!y.test(typeof a)&&!c.isFile(a)){if("file"==a.type&&a.files)h[b]=a.files;k(a)?c.each(a,d):e=!1}});e||c.each(h,function E(a){c.isFile(a)?(p++,c.readAsBinaryString(a,function(c){"load"==c.type?(a.data=c.result,b()):g(0,{statusText:c.type})})):o.test(a.nodeName)||a.data&&o.test(a.data.nodeName)?(p++,
c.readAsDataURL(a.data||a,function(c){"load"==c.type?(a.type="image/png",a.data=FileAPI.toBinaryString(c.result),b()):g(0,{statusText:c.type})})):k(a)&&c.each(a,E)});b();return f},reset:function(a){var b,c;i.jQuery?(c=jQuery(a).clone(!0).insertBefore(a).val("")[0],jQuery(a).remove()):(b=a.parentNode,c=b.insertBefore(a.cloneNode(!0),a),c.value="",b.removeChild(a));return c}};i.FileAPI=c})(this);


(function(n,h){function e(b,a){if(!(this instanceof e))return new e(b,a);this.canvas=h.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.width=this.canvas.width=b;this.height=this.canvas.height=a}var i=Math.min,m=!!function(){var b=h.createElement("Canvas");return b.getContext&&~b.toDataURL("image/png").indexOf("data:image/png")}(),g=m?!1:function(b){return b};n.extend({canvas:m,rotate:g||function(b,a){var c=b.width,d=b.height;return e(!(a%180)?c:d,a%180?c:d).rotate(a).draw(b,180==
a||270==a?-c:0,90==a||180==a?-d:0,c,d).ok()},crop:g||function(b,a,c,d,f){return e(d,f).draw(b,a,c,d,f,0,0,d,f).ok()},resize:g||function(b,a,c){return e(a,c).draw(b,0,0,a,c).ok()},resizeByMax:g||function(b,a,c){c||(c=a);var d=b.width,f=b.height,j=d/f;j>=a/c?(a=i(d,a),c=a/j):(c=i(f,c),a=c*j);return e(a,c).draw(b).ok()}});e.prototype={constructor:e,draw:function(b,a,c,d,f,e,g,h,i){var k=this.width,l=this.height;"undefined"!==typeof e?this.ctx.drawImage(b,a||0,c||0,d||k,f||l,e||0,g||0,h||k,i||l):this.ctx.drawImage(b,
a||0,c||0,d||k,f||l);return this},rotate:function(b){this.ctx.rotate(b*Math.PI/180);return this},ok:function(){this.ctx=null;return this.canvas}}})(FileAPI,document);
