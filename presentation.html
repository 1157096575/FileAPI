<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>FileAPI: Загрузка файлов на сервер</title>

	<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

	<link rel="stylesheet" href="http://lab.hakim.se/reveal-js/css/reset.css">
	<link rel="stylesheet" href="http://lab.hakim.se/reveal-js/css/main.css">
	<link rel="stylesheet" href="http://lab.hakim.se/reveal-js/css/print.css" type="text/css" media="print">
	<link rel="stylesheet" href="http://lab.hakim.se/reveal-js/css/theme/default.css">
	<link rel="stylesheet" href="http://lab.hakim.se/reveal-js/lib/css/zenburn.css">

	<style>
		.reveal .slides h2,
		.reveal .slides h3 {
			font-family: helveticaneue;
			text-transform: none;
		}
		.reveal .slides section {
			font-size: 35px;
			font-family: helveticaneue;
			line-height: 170%;
		}
		pre .xml .css, pre .xml .javascript, pre .xml .vbscript, pre .tex .formula {
			color: #fff;
			opacity: 1;
		}
		pre code {
			margin-top: 100px;
		}

		.list {
			color: rgba(255,255,255,.3);
		}
			.list__item {
				color: #fff;
			}

		.api__name {
			color: #fff;
			font-weight: bold;
		}
		.api__args {
			color: #ccc;
		}
		.api__descr {
			color: #eee;
		}
	</style>
</head>
<body>


	<div class="reveal">
		<div class="slides">
			<section>
				<section>
					<h1 style="margin: 160px 0 0; font-size: 280px">File API</h1>
				</section>

				<section>
					<h3>Требования</h3>
					<ul class="list" style="margin-top: 20px">
						<li><span class="list__item">Выбор нескольких файлов для загрузки</span></li>
						<li><span class="list__item">Получение информации о файле (название, размер и mime-тип)</span></li>
						<li><span class="list__item">Создать preview изображения до загрузки</span></li>
						<li><span class="list__item">Ресайз, кроп и поворот на клиенте</span></li>
						<li><span class="list__item">Загрузка всего, что получилось на сервер (cross-domain request)</span></li>
						<li><span class="list__item">Не зависеть от сторонних библиотек (по возможности)</span></li>
					</ul>
				</section>

				<section>
					<h3>Поддержка FileAPI на 2012 год</h3>
					<div id="Browsers" style="margin-top: 80px; height: 350px;"></div>
				</section>

				<section>
					<h3>Получение списка файлов</h3>
					<pre style="margin-top: 100px; font-size: 24px"><code class="html" contenteditable>&lt;input id="file" type="file" multiple />
&lt;script>​
    var inputFile = document.getElementById('file');

    inputFile.addEventListener('change', function (evt){
    	// получаем список файлов
    	var files = fileInput.files;
    }, false);​
&lt;/script>​</code></pre>
				</section>

				<section>
					<h3>То, что получилось</h3>
					<pre style="margin-top: 100px; font-size: 22px;"><code class="html">&lt;span style="position: relative">
    &lt;input id="file" type="file" multiple />
&lt;/span>
&lt;script>​
    var inputFile = document.getElementById('file');

    FileAPI.event.on(inputFile, 'change', function (evt){
        // Получаем список файлов
        var files = FileAPI.getFiles(fileInput);
    });​
&lt;/script>​</code></pre>
				</section>

				<section>
					<h3>Передача списка файлов из Flash</h3>
					<pre style="font-size: 30px;"><code class="js">Flash --> jsCallback([​{
    uid: '...', // уникальный идетификатор
    name: '...', // название файла
    type: 'image/jpeg', // mime-type
    size: 43235 // размер
}​, {
    // ...
}]​);</code></pre>
				</section>

				<section>
					<h3>Фильтрация</h3>
					<div xclass="fragment">
						<pre style="font-size: 24px;"><code class="js">FileAPI.filterFiles(files, function (file, info){
    // Функция филтрации
    if( /image/.test(file.type) && info ){
        return info.width > 120 && info.height > 120;
    } else {
        return file.size > 1024;
    }
}, function (files, deleted){
    // Завершение фильтрации
});​</code></pre>
					</div>
				</section>

				<section>
					<h3>Создание preview</h3>
					<ul style="margin-top: 60px" class="list">
						<li><span class="list__item"><span class="api__name">FileReader</span><span class="api__descr"> — позволяет асинхронно прочесть содержимое файла</span></span></li>
						<li><span class="list__item"><span class="api__name">URL.createObjectURL</span><span class="api__args">(file)</span><span class="api__descr"> — создает ссылку, указывающую на файл</span></span></li>
					</ul>
				</section>

				<section>
					<h3>FileReader</h3>
					<pre style="font-size: 28px;"><code style="margin-top: 50px" class="js">function readAsImage(file, callback){
    var Reader = new FileReader;
    Reader.onload = function (evt){
        var img = new Image;
        img.onload = function (){
            callback(img);
        };
        img.src = evt.target.result;
    };
    Reader.readAsDataURL(file);
}</code></pre>
				</section>

				<section>
					<h3>URL.createObjectURL</h3>
					<pre style="font-size: 30px;"><code class="js">function readAsImage(file, callback){
    var img = new Image;
    img.onload = function (){
        URL.revokeObjectURL(file);
        callback(img);
    };
    img.src = URL.createObjectURL(file);
}</code></pre>
				</section>

				<section>
					<h3>Создание preview через API</h3>
					<pre style="font-size: 28px"><code style="margin-top: 60px" class="js">FileAPI.Image(imageFile)
    .preview(120, 120)
    .get(function (err, img/**HTMLImage*/){
        if( err ){
            // обработка ошибки
        } else {
            document.body.appendChild(img);
        }
    })
;</code></pre>
				</section>

				<section>
					<h3>FileAPI.Image</h3>
					<ul class="list" style="margin-top: 50px">
						<li><span class="list__item"><span class="api__name">crop</span><span class="api__args">(x, y, width, height)</span><span class="api__descr"> — кадрирование</span></span></li>
						<li><span class="list__item"><span class="api__name">resize</span><span class="api__args">(width[, height])</span><span class="api__descr"> — масштабирование</span></span></li>
						<li><span class="list__item"><span class="api__name">rotate</span><span class="api__args">(deg)</span><span class="api__descr"> — поворот</span></span></li>
						<li><span class="list__item"><span class="api__name">preview</span><span class="api__args">(width[, height])</span><span class="api__descr"> — автоматически кадрирует и масштабирует</span></span></li>
						<li><span class="list__item"><span class="api__name">get</span><span class="api__args">(callback)</span><span class="api__descr"> — получить итоговое изображение</span></span></li>
					</ul>
				</section>

				<section>
					<h3>&laquo;Матрица&raquo; трансформации</h3>
					<pre style="font-size: 24px"><code class="js">{
    // параметры фрагмента оригинального изображения
    sx: Number,
    sy: Number,
    sw: Number,
    sh: Number,

    // требуемые размеры
    dw: Number,
    dh: Number,
    deg: Number, // на сколько градусов повернуть
    resize: String, // тип ресайза: min, max и preview
}</code></pre>
				</section>

				<section>
					<h3>Взаимодействие со флешом</h3>
					<pre style="font-size: 28px;"><code class="js">flash.cmd('imageTransform', {
   id: '...', // uniq file id
   transform: {}, // "matrix"
   callback: 'FileAPI.Flash._fn.__UNIQ_NAME__'
});​​​​</code></pre>
				</section>

				<section>
					<h3>Объект параметров</h3>
					<ul style="margin-top: 60px;" class="list">
						<li><span class="list__item"><span class="api__name">id</span><span class="api__descr"> — уникальный идентификатор файла, по которому флешка определяет, для какого файла, ей нужно выполнить ту или иную команду.</span></span></li>
						<li><span class="list__item"><span class="api__name">transform</span><span class="api__descr"> — это та самая &laquo;матрица&raquo; трансформации</span></span></li>
						<li><span class="list__item"><span class="api__name">callback</span><span class="api__descr"> — название функции, которую вызовет флеш, по завершению</span></span></li>
					</ul>
				</section>

				<section>
					<h3>Загрузка файлов</h3>
					<pre style="font-size: 23px"><code style="margin-top: 30px;" class="js">var xhr = ​FileAPI.upload({
    url: '...',
    data: { foo: 'bar' },
    headers: { 'Session-Id': '...' },
    files: {
        images: imageFiles,
        others: otherFiles,
    },
    imageTransform: {
        maxWidth: 1024,
        maxHeight: 768
    },
    upload: function (xhr){},
    fileupload: function (xhr){},
    fileprogress: function (event){},
    filecomplete: function (status, xhr){}
    progress: function (event){},
    complete: function (status){}
});​</code></pre>
				</section>


				<section>
					<h3>Параметры загрузки</h3>
					<ul class="list">
						<li><span class="list__item"><span class="api__name">url</span><span class="api__descr"> — куда загружаем</span></span></li>
						<li><span class="list__item"><span class="api__name">data</span><span class="api__descr"> — дополнительная POST-data</span></span></li>
						<li><span class="list__item"><span class="api__name">headers</span><span class="api__descr"> — дополнительные заголовки запроса (в данном случае id сессии)</span></span></li>
						<li><span class="list__item"><span class="api__name">files</span><span class="api__descr"> — это объект, у которого “key” название POST-параметра, а значение файл(ы)</span></span></li>
						<li><span class="list__item"><span class="api__name">imageTransform</span><span class="api__descr"> — правила трансформации для картинок, max — не более, min — не менее, заданных размеров</span></span></li>
					</ul>
				</section>

				<section>
					<h3>События загрузки</h3>
					<ul class="list" style="margin-top: 30px">
						<li><span class="list__item"><span class="api__name">upload</span><span class="api__args">(xhr)</span><span class="api__descr"> — будет вызван перед началом загрузки всех файлов</span></span></li>
						<li><span class="list__item"><span class="api__name">fileupload</span><span class="api__args">(xhr)</span><span class="api__descr"> — перед загрузкой каждого файла</span></span></li>
						<li><span class="list__item"><span class="api__name">fileprogress</span><span class="api__args">(evt)</span><span class="api__descr"> — прогресс загрузки текущего файла</span></span></li>
						<li><span class="list__item"><span class="api__name">filecomplete</span><span class="api__args">(status, xhr)</span><span class="api__descr"> — завершение загрузки файла</span></span></li>
						<li><span class="list__item"><span class="api__name">progress</span><span class="api__args">(evt)</span><span class="api__descr"> — общий процесс загрузки</span></span></li>
						<li><span class="list__item"><span class="api__name">complete</span><span class="api__args">(status, xhr)</span><span class="api__descr"> — завершение всей загрузки</span></span></li>
					</ul>
				</section>

				<section>
					<h3>Описание объекта xhr</h3>
					<ul class="list" style="margin-top: 30px">
						<li><span class="list__item"><span class="api__name">status</span><span class="api__descr"> — HTTP status code</span></span></li>
						<li><span class="list__item"><span class="api__name">statusText</span><span class="api__descr"> — HTTP status text</span></span></li>
						<li><span class="list__item"><span class="api__name">responseText</span><span class="api__descr"> — ответ сервера</span></span></li>
						<li><span class="list__item"><span class="api__name">getResponseHeader</span><span class="api__args">(name)</span><span class="api__descr"> — получить заголовок ответа сервера</span></span></li>
						<li><span class="list__item"><span class="api__name">getAllResponseHeaders</span><span class="api__args">()</span><span class="api__descr"> — получить все заголовки</span></span></li>
						<li><span class="list__item"><span class="api__name">abort</span><span class="api__args">()</span><span class="api__descr"> — отменить загрузку</span></span></li>
					</ul>
				</section>


				<section>
					<h3>IFrame: FileAPI.getFiles</h3>
					<pre style="font-size: 30px;"><code class="js">[{
    name: '...', // название файла
    type: '...', // тип или расширение
    input: fileInput // ссылка на инпут
}]</code></pre>
				</section>

				<section>
					<h3>IFrame-транспорт</h3>
					<pre><code style="margin-top: 30px" class="html">&lt;form target="__UNIQ__" action="..." method="post" enctype="multipart/form-data">
    &lt;iframe name="__UNIQ__">&lt;/iframe>
    &lt;input name="jsonp" value="parent.FileAPI.Flash._fn.fileapi123" type="hidden"/>
    &lt;input name="foo" value="bar" type="hidden"/>
&lt;/form></code></pre>
					<div class="fragment">
						<h3 style="margin-top: 70px">Подписка на событие</h3>
						<pre><code style="margin-top: 40px" class="js">FileAPI.event.on(inputFile, 'change', function (evt){
    // ...
});​</code></pre></div>
				</section>

				<section>
					<h3>Выводы</h3>
					<div>

					</div>
				</section>

				<section>
					<h3>В ролях</h3>
					<ul style="margin-top: 50px" class="list">
						<li><span class="list__item"><span class="api__name">FileAPI</span><span class="api__descr"> — a set of tools for working with files (https://github.com/RubaXa/FileAPI)</span></span></li>
						<li style="margin-top: 30px"><span class="list__item"><span class="api__name">reveal.js</span><span class="api__descr"> — HTML5 Presentation Tool (https://github.com/hakimel/reveal.js)</span></span></li>
					</ul>
				</section>

			</section>
		</div>
	</div>

	<script src="http://lab.hakim.se/reveal-js/lib/js/head.min.js"></script>
	<script src="https://raw.github.com/hakimel/reveal.js/master/js/reveal.js"></script>
	<script src="http://lab.hakim.se/reveal-js/lib/js/classList.js"></script>
	<script src="http://lab.hakim.se/reveal-js/lib/js/highlight.js"></script>
	<script src="https://www.google.com/jsapi"></script>

	<script>
		google.load("visualization", "1", { packages: ["corechart"] });
		google.setOnLoadCallback(function drawChart() {
			Reveal.initialize({
				controls: true, // Display controls in the bottom right corner
				progress: true, // Display a presentation progress bar
				history: true, // Push each slide change to the browser history
				keyboard: true, // Enable keyboard shortcuts for navigation
				loop: false, // Loop the presentation
				rollingLinks: true, // Apply a 3D roll to links on hover
				theme: 'default', // default/neon/beige
				transition: 'default' // default/cube/page/concave/linear(2d)
			});



			var data = google.visualization.arrayToDataTable([
				  ['Браузер', 'Процент использования']
				, ['Chrome 10+', 26]
				, ['FireFox 4+', 19]
				, ['Opera 11.2+', 17]
				, ['Safari 4+', 1.4]
				, ['Без FileAPI', 36.6]
			]);

			var chart = new google.visualization.PieChart(document.getElementById('Browsers'));
			chart.draw(data, {
				  fontSize: 27
				, is3D: true
				, chartArea: { width: '70%', height: '90%' }
				, legend: { textStyle: { color: 'white' } }
				, backgroundColor: 'transparent'
				, colors: ['#36c', '#109618', '#909', '#f90', '#DC3912']
				, tooltip: { text: 'percentage' }
			});

			var code = document.getElementsByTagName('code'), i = code.length;
			while( i-- ){
				hljs.highlightBlock(code[i]);
			}

		});
	</script>

</body>
</html>
