<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>FileAPI: Загрузка файлов на сервер</title>

	<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

	<link rel="stylesheet" href="http://lab.hakim.se/reveal-js/css/reset.css">
	<link rel="stylesheet" href="http://lab.hakim.se/reveal-js/css/main.css">
	<link rel="stylesheet" href="http://lab.hakim.se/reveal-js/css/print.css" type="text/css" media="print">

	<link rel="stylesheet" href="http://lab.hakim.se/reveal-js/lib/css/zenburn.css">
	<style>
		.reveal .slides h2,
		.reveal .slides h3 {
			font-family: arial,sans-serif;
			text-transform: none;
		}
		.reveal .slides section {
			font-size: 35px;
			font-family: arial,sans-serif;
			line-height: 170%;
		}
		pre .xml .css, pre .xml .javascript, pre .xml .vbscript, pre .tex .formula {
			color: #fff;
			opacity: 1;
		}
		pre code {
			margin-top: 100px;
		}
	</style>
</head>
<body>


	<div class="reveal">
		<div class="slides">
			<section>
				<section>
					<h2 style="margin-top: 80px;">Загрузка файлов<br/>на<br/>сервер</h2>
				</section>

				<section>
					<h3>Задачи, которые нужно решить</h3>
					<ul style="margin-top: 20px">
						<li>Выбирать несколько файлов для загрузки</li>
						<li>Получать информацию о файле (название, размер и mime-тип)</li>
						<li>Создать preview изображения до загрузки</li>
						<li>Ресайз, кроп и поворот на клиенте</li>
						<li>Загрузка всего, что получилось на сервер (cross-domain request)</li>
						<li>Не зависеть от сторонних библиотек (по возможности)</li>
					</ul>
				</section>

				<section>
					<h3>Бразуеры, которые поддерживают FileAPI и их распространенность на 2012 год</h3>
					<div id="Browsers" style="margin-top: 40px; height: 350px;"></div>
				</section>

				<section>
					<h3>Вот так выглядит получение списка файлов на html5</h3>
					<pre style="margin-top: 100px;"><code class="html" contenteditable>&lt;input id="file" type="file" multiple />
&lt;script>​
    var inputFile = document.getElementById('file');

    inputFile.addEventListener('change', function (evt){
    	// получаем список файлов
    	var files = fileInput.files;
    }, false);​
&lt;/script>​</code></pre>
				</section>

				<section>
					<h3>То, что получилось</h3>
					<pre style="margin-top: 100px;"><code class="html">&lt;span style="position: relative">
    &lt;input id="file" type="file" multiple />
&lt;/span>
&lt;script>​
    var inputFile = document.getElementById('file');

    FileAPI.event.on(inputFile, 'change', function (evt){
        // Получаем список файлов
        var files = FileAPI.getFiles(fileInput);
    });​
&lt;/script>​</code></pre>
				</section>

				<section>
					<h3>Передача списка файлов от Flash в js</h3>
					<pre><code class="js">Flash --> jsFunc([​{
    uid: '...', // уникальный идетификатор
    name: '...', // название файла
    type: 'image/jpeg', // mime-type
    size: 43235 // размер
}​, {
    // ...
}]​);</code></pre>
				</section>

				<section>
					<h3>Фильтрация</h3>
					<div xclass="fragment">
						<pre><code class="js">FileAPI.filterFiles(files, function (file, info){
    // Функция филтрации
    if( /image/.test(file.type) && info ){
        return info.width > 120 && info.height > 120;
    } else {
        return file.size > 1024;
    }
}, function (files, deleted){
    // Завершение фильтрации
});​</code></pre>
					</div>
				</section>

				<section>
					<h3>Создание preview для изображения</h3>
					<ul>
						<li>FileReader — позволяет асинхронно прочесть содержимое файла</li>
						<li>URL.createObjectURL(file) — создает ссылку, указывающую на файл</li>
					</ul>
				</section>

				<section>
					<h3>FileReader</h3>
					<pre><code class="js">function readAsImage(file, callback){
    var Reader = new FileReader;
    Reader.onload = function (evt){
        var img = new Image;
        img.onload = function (){
            callback(img);
        };
        img.src = evt.target.result;
    };
    Reader.readAsDataURL(file);
}</code></pre>
				</section>

				<section>
					<h3>URL.createObjectURL</h3>
					<pre><code class="js">function readAsImage(file, callback){
    var img = new Image;
    img.onload = function (){
        URL.revokeObjectURL(file);
        callback(img);
    };
    img.src = URL.createObjectURL(file);
}</code></pre>
				</section>

				<section>
					<h3>Создание preview через API</h3>
					<pre><code class="js">var imageFiles = FileAPI.filter(files, function (file){
    return /image/i.test(file.type);
});

FileAPI.each(imageFiles, function (imageFile){
    FileAPI.Image(imageFile)
        .preview(120, 120)
        .get(function (err, img/**HTMLImage*/){
            if( err ){
                // обработка ошибки
            } else {
                document.body.appendChild(img);
            }
        })
    ;
});</code></pre>
				</section>

				<section>
					<h3>Класс FileAPI.Image</h3>
					<ul style="margin-top: 50px">
						<li>crop(x, y, width, height) — кадрирование</li>
						<li>resize(width, height) — масштабирование</li>
						<li>rotate(deg) — поворот</li>
						<li>preview(width, height) — автоматически кадрирует и масштабирует</li>
						<li>get(callback) — получить итоговое изображение</li>
					</ul>
				</section>

				<section>
					<h3>&laquo;Матрица&raquo; трансформации</h3>
					<pre><code class="js">{
    // параметры фрагмента оригинального изображения
    sx: Number,
    sy: Number,
    sw: Number,
    sh: Number,

    // требуемые размеры
    dw: Number,
    dh: Number,
    deg: Number, // на сколько градусов повернуть
    resize: String, // тип ресайза: min, max и preview
}</code></pre>
				</section>

				<section>
					<h3>Публичный метод для взаимодействия со флешом</h3>
					<pre><code class="js">flash.cmd('imageTransform', {
    id: '...', // uniq file id
    transform: {}, // "matrix"
    callback: 'FileAPI.Flash._fn.__UNIQ_NAME__'
});​​​​</code></pre>
				</section>

				<section>
					<h3>???</h3>
					<ul>
						<li>id — уникальный идентификатор файла, по которому флешка определяет, для какого файла, ей нужно выполнить ту или иную команду.</li>
						<li>transform — это та самая &laquo;матрица&raquo; трансформации</li>
						<li>callback — название функции, которую вызовет флеш, по завершению</li>
					</ul>
				</section>

				<section>
					<h3>Загрузка файлов</h3>
					<pre><code style="margin-top: 30px;" class="js">var xhr = ​FileAPI.upload({
    url: '...',
    data: { foo: 'bar' },
    headers: { 'Session-Id': '...' },
    files: {
        images: imageFiles,
        others: otherFiles,
    },
    imageTransform: {
        maxWidth: 1024,
        maxHeight: 768
    },
    upload: function (xhr){},
    fileupload: function (xhr){},
    fileprogress: function (event){},
    filecomplete: function (status, xhr){}
    progress: function (event){},
    complete: function (status){}
});​</code></pre>
				</section>


				<section>
					<h3>Параметры загрузки</h3>
					<ul>
						<li>url — куда загружаем</li>
						<li>data — дополнительная POST-data</li>
						<li>headers — дополнительные заголовки запроса (в данном случае id сессии)</li>
						<li>files — это объект, у которого “key” название POST-параметра, а значение файл(ы)</li>
						<li>imageTransform — правила трансформации для картинок, max — не более, min — не менее, заданных размеров</li>
					</ul>
				</section>

				<section>
					<h3>События загрузки</h3>
					<ul style="margin-top: 30px">
						<li>upload(xhr) — будет вызван перед началом загрузки всех файлов</li>
						<li>fileupload(xhr) — перед загрузкой каждого файла</li>
						<li>fileprogress(evt) — прогресс загрузки текущего файла</li>
						<li>filecomplete(status, xhr) — завершение загрузки файла</li>
						<li>progress(evt) — общий процесс загрузки</li>
						<li>complete(status, xhr) — завершение загрузки всех файлов</li>
					</ul>
				</section>

				<section>
					<h3>Описание объекта xhr</h3>
					<ul style="margin-top: 30px">
						<li>status — HTTP status code</li>
						<li>statusText — HTTP status text</li>
						<li>responseText — ответ сервера</li>
						<li>getResponseHeader(name) — получить заголовок ответа сервера</li>
						<li>getAllResponseHeaders() — получить все заголовки</li>
						<li>abort() — отменить загрузку</li>
					</ul>
				</section>


				<section>
					<h3>IFrame: FileAPI.getFiles</h3>
					<pre><code class="js">[{
    name: '...', // название файла
    type: '...', // тип или расширение
    input: fileInput // ссылка на инпут
}]</code></pre>
				</section>

				<section>
					<h3>IFrame-транспорт</h3>
					<pre><code class="html">&lt;form target="__UNIQ__" action="..." method="post" enctype="multipart/form-data">
    &lt;iframe name="__UNIQ__">&lt;/iframe>
    &lt;input name="jsonp" value="parent.FileAPI.Flash._fn.fileapi123" type="hidden"/>
    &lt;input name="foo" value="bar" type="hidden"/>
&lt;/form></code></pre>
				</section>

				<section>
					<h3>Подписка на события</h3>
					<pre><code class="js">FileAPI.event.on(inputFile, 'change', function (evt){
    // ...
});​</code></pre>
				</section>

				<section>
					<h3>Выводы</h3>
					<div>
						
					</div>
				</section>

				<section>
					<h3>В ролях</h3>
					<ul>
						<li>FileAPI — a set of tools for working with files (https://github.com/RubaXa/FileAPI)</li>
						<li>reveal.js — HTML5 Presentation Tool (https://github.com/hakimel/reveal.js)</li>
					</ul>
				</section>

			</section>
		</div>
	</div>

	<script src="https://raw.github.com/hakimel/reveal.js/master/js/reveal.js"></script>
	<script src="http://lab.hakim.se/reveal-js/lib/js/classList.js"></script>
	<script src="http://lab.hakim.se/reveal-js/lib/js/highlight.js"></script>
	<script src="https://www.google.com/jsapi"></script>

	<script>
		google.load("visualization", "1", { packages: ["corechart"] });
		google.setOnLoadCallback(function drawChart() {
			Reveal.initialize({
				controls: true, // Display controls in the bottom right corner
				progress: true, // Display a presentation progress bar
				history: true, // Push each slide change to the browser history
				keyboard: true, // Enable keyboard shortcuts for navigation
				loop: false, // Loop the presentation
				rollingLinks: true, // Apply a 3D roll to links on hover
				theme: 'default', // default/neon/beige
				transition: 'default' // default/cube/page/concave/linear(2d)
			});



			var data = google.visualization.arrayToDataTable([
				  ['Браузер', 'Процент использования']
				, ['Chrome 10+', 26]
				, ['FireFox 4+', 19]
				, ['Opera 11.2+', 17]
				, ['Safari 4+', 1.4]
				, ['Без FileAPI', 36.6]
			]);

			var chart = new google.visualization.PieChart(document.getElementById('Browsers'));
			chart.draw(data, {
				  fontSize: 27
				, is3D: true
				, chartArea: { width: '70%', height: '90%' }
				, legend: { textStyle: { color: 'white' } }
				, backgroundColor: 'transparent'
				, colors: ['#36c', '#109618', '#909', '#f90', '#DC3912']
				, tooltip: { text: 'percentage' }
			});

			var code = document.getElementsByTagName('code'), i = code.length;
			while( i-- ){
				hljs.highlightBlock(code[i]);
			}

		});
	</script>

</body>
</html>
